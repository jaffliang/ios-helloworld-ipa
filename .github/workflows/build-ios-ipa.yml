name: Build iOS IPA (Unsigned)

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-ios:
    runs-on: macos-15
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install dependencies
        run: npm install

      - name: Add iOS platform
        run: npx cap add ios

      - name: Sync iOS project
        run: npx cap sync ios

      - name: Build unsigned IPA
        run: |
          cd ios/App
          xcodebuild build \
            -workspace App.xcworkspace \
            -scheme App \
            -configuration Release \
            -sdk iphoneos \
            -derivedDataPath build \
            ONLY_ACTIVE_ARCH=NO \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO

      - name: Package IPA
        run: |
          cd ios/App/build/Build/Products/Release-iphoneos
          mkdir Payload
          cp -r App.app Payload/
          zip -r HelloWorld.ipa Payload

      - name: Extract version info
        id: version
        run: |
          # ä½¿ç”¨ commit çš„å‰7ä½ä½œä¸ºç‰ˆæœ¬å·
          VERSION=$(git rev-parse --short HEAD)
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          # ä½¿ç”¨å½“å‰æ—¥æœŸä½œä¸º tag åç§°
          TAG_NAME="ios-$(date +%Y%m%d-%H%M%S)"
          echo "tag=${TAG_NAME}" >> $GITHUB_OUTPUT

      - name: Create Release and Upload IPA
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: iOS Unsigned IPA ${{ steps.version.outputs.tag }}
          body: |
            ## æ— ç­¾å iOS IPA (é€‚ç”¨äºå·¨é­”è®¾å¤‡)

            ### ğŸ“± åº”ç”¨ä¿¡æ¯
            - **åº”ç”¨åç§°**: HelloWorldiOS
            - **Bundle ID**: com.jaffliang.helloworld
            - **ç‰ˆæœ¬**: ${{ steps.version.outputs.version }}
            - **æ„å»ºæ—¶é—´**: ${{ github.event.head_commit.timestamp }}

            ### âš ï¸ æ³¨æ„äº‹é¡¹
            - æ­¤ IPA ä¸º**æœªç­¾åç‰ˆæœ¬**ï¼Œéœ€è¦é€šè¿‡å·¨é­”å•†åº—æˆ–å…¶ä»–å·¥å…·ç­¾ååå®‰è£…
            - æœ€ä½æ”¯æŒ iOS 14.0+

            ### ğŸ“¥ ä¸‹è½½
            ç‚¹å‡»ä¸‹æ–¹çš„ `HelloWorld.ipa` æ–‡ä»¶ä¸‹è½½
          files: ios/App/build/Build/Products/Release-iphoneos/HelloWorld.ipa
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload IPA artifact (backup)
        uses: actions/upload-artifact@v4
        with:
          name: ios-unsigned-ipa
          path: ios/App/build/Build/Products/Release-iphoneos/HelloWorld.ipa
          retention-days: 30
