name: Build iOS IPA (Unsigned)

# 触发条件：push 到 main 分支，或手动触发
on:
  push:
    branches: [ main ]
  workflow_dispatch: # 手动触发开关

jobs:
  build-ios:
    # 使用 GitHub 提供的 macOS 虚拟机（自带 Xcode）
    runs-on: macos-latest
    steps:
      # 1. 拉取仓库代码
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. 安装 Node.js（Capacitor 依赖）
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20 # 兼容 Capacitor 6
          cache: 'npm'

      # 3. 安装项目依赖（Capacitor）
      - name: Install dependencies
        run: npm install

      # 4. 初始化 Capacitor iOS 项目
      - name: Initialize Capacitor iOS
        run: |
          npx cap add ios        # 添加 iOS 平台
          npx cap sync ios       # 同步前端资源到 iOS 项目

      # 4.5 检查 iOS 项目结构
      - name: List iOS project files
        run: |
          echo "iOS 目录结构:"
          ls -la ios/
          echo ""
          echo "App 目录结构:"
          ls -la ios/App/ || true
          echo ""
          echo "查找 xcworkspace 文件:"
          find ios -name "*.xcworkspace" -type d
          echo ""
          echo "查找 scheme:"
          xcodebuild -workspace ios/App/App.xcworkspace -list 2>/dev/null || echo "无法列出 schemes"

      # 5. 安装 CocoaPods 依赖（iOS 原生依赖）
      - name: Install CocoaPods
        run: |
          cd ios/App
          pod install --repo-update

      # 6. Xcode 构建 iOS 项目（无签名，适配巨魔设备）
      - name: Build iOS app (Unsigned)
        run: |
          # 列出可用的 schemes
          echo "可用的 schemes:"
          xcodebuild -workspace ios/App/App.xcworkspace -list

          # 关键：使用 Xcodebuild 构建无签名的 IPA
          xcodebuild \
            -workspace ios/App/App.xcworkspace \
            -scheme App \
            -configuration Debug \
            -destination 'generic/platform=iOS' \
            -archivePath ./build/HelloWorld.xcarchive \
            archive \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO

      # 7. 导出无签名的 IPA 文件
      - name: Export Unsigned IPA
        run: |
          # 创建导出配置文件（指定无签名）
          cat > exportOptions.plist << EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>method</key>
              <string>development</string>
              <key>signingStyle</key>
              <string>manual</string>
              <key>compileBitcode</key>
              <false/>
              <key>stripSwiftSymbols</key>
              <false/>
              <key>teamID</key>
              <string>XXXX</string> <!-- 随便填，无签名不验证 -->
              <key>provisioningProfiles</key>
              <dict>
                  <key>com.jaffliang.helloworld</key> <!-- 替换为自己的 bundleId -->
                  <string>XXXX</string> <!-- 随便填 -->
              </dict>
          </dict>
          </plist>
          EOF

          # 导出 IPA
          xcodebuild -exportArchive \
            -archivePath ./build/HelloWorld.xcarchive \
            -exportPath ./build/ipa \
            -exportOptionsPlist exportOptions.plist \
            -allowProvisioningUpdates \
            CODE_SIGNING_ALLOWED=NO

      # 8. 上传 IPA 作为 GitHub 产物（可下载）
      - name: Upload IPA Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-unsigned-ipa # 产物名称
          path: ./build/ipa/*.ipa # IPA 文件路径
          retention-days: 30 # 保留 30 天
